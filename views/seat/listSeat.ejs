<%- include('../partials/header.ejs') %>
<div class="container mt-5 p-5">
  <h2 class="text-center">Quản lý ghế</h2>
  <form id="seatForm">
    <div class="row row-cols-2 mt-5 mb-4">
      <div class="col-6">
        <label for="cinemaSelect" class="form-label h6">Rạp phim</label>
        <select id="cinemaSelect" class="form-select">
          <option selected disabled>Chọn Rạp Phim...</option>
          <% for(let i = 0; i < dataCinemas.length; i++){ %>
          <option value="<%= dataCinemas[i]._id %>">
            <%= dataCinemas[i].name %>
          </option>
          <% } %>
        </select>
      </div>
      <div class="col-6">
        <label for="roomSelect" class="form-label h6">Phòng chiếu</label>
        <select id="roomSelect" class="form-select">
          <option selected disabled>Chọn Phòng Chiếu...</option>
          <option value="room1">Room 1</option>
        </select>
      </div>
      <div class="col-6 mt-4">
        <label for="showDataSelect" class="form-label h6">Ngày chiếu</label>
        <select id="showDataSelect" class="form-select">
          <option selected disabled>Chọn Ngày Chiếu...</option>
          <option value="room1">Room 1</option>
          <option value="room2">Room 2</option>
        </select>
      </div>
      <div class="col-6 mt-4">
        <label for="timeSelect" class="form-label h6">Giờ chiếu</label>
        <select id="timeSelect" class="form-select">
          <option selected disabled>Chọn Giờ Chiếu...</option>
          <option value="room1">Room 1</option>
          <option value="room2">Room 2</option>
        </select>
      </div>
    </div>
  </form>
  <div class="d-flex justify-content-center">
    <button
      class="btn btn-primary mb-4"
      data-bs-toggle="modal"
      data-bs-target="#addSeatModal"
    >
      Thêm hàng ghế mới
    </button>
    <button id="viewSeatsBtn" class="btn btn-primary mb-4 ms-3">Xem Ghế</button>
    <button class="btn btn-primary mb-4 ms-3">Edit</button>
    <button class="btn btn-danger mb-4 ms-3">Delete</button>
  </div>
  <!-- Seat -->
  <div id="seats" class="row justify-content-center"></div>
  <!-- Modal Add Seat -->
  <div
    class="modal fade"
    id="addSeatModal"
    tabindex="-1"
    aria-labelledby="addSeatModalLabel"
    aria-hidden="true"
  >
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <!-- Modal Header -->
        <div class="modal-header">
          <h1 class="modal-title fs-5" id="addSeatModalLabel">
            <i class="fas fa-exclamation-triangle text-danger"></i>
            Thêm hàng ghế mới
          </h1>
          <button
            type="button"
            class="btn-close"
            data-bs-dismiss="modal"
            aria-label="Close"
          ></button>
        </div>
        <!-- Modal Body -->
        <div class="modal-body">
          <label for="seatSelect" class="form-label h6">Tên ghế</label>
          <select id="seatSelect" class="form-select">
            <option selected disabled>Chọn tên ghế...</option>
          </select>
          <div id="priceContainer" class="mt-3">
            <label for="seatPrice" class="form-label h6">Giá tiền</label>
            <input type="text" id="seatPrice" class="form-control" readonly />
          </div>
          <label for="roomSelect" class="form-label h6">Phòng chiếu</label>
          <select id="roomSelect" class="form-select">
            <option selected disabled>Chọn Phòng Chiếu...</option>
            <option value="room1">Room 1</option>
          </select>
        </div>
        <!-- Modal Footer -->
        <div class="modal-footer">
          <button
            type="button"
            class="btn btn-secondary"
            data-bs-dismiss="modal"
          >
            Close
          </button>
          <button type="button" class="btn btn-danger" id="confirmAdd">
            Lưu thông tin
          </button>
        </div>
      </div>
    </div>
  </div>
</div>
<!-- Add Seat -->
<script>
  document
    .getElementById("confirmAdd")
    .addEventListener("click", async function () {});
</script>
<!-- Chọn ghế tự động tính tiền -->
<script>
  var existingSeats = [];
  document.addEventListener("DOMContentLoaded", function () {
    const seatSelect = document.getElementById("seatSelect");
    const seatPrice = document.getElementById("seatPrice");
    const roomSelect = document.getElementById("roomSelect");

    // Generate seat options from A1 to H8
    const seats = [];
    const rows = ["A", "B", "C", "D", "E", "F", "G", "H"];
    const columns = 8;

    rows.forEach((row) => {
      for (let i = 1; i <= columns; i++) {
        seats.push(`${row}${i}`);
      }
    });

    // Danh sách các ghế có thể chọn sau khi loại bỏ các ghế đã có sẵn
    const availableSeats = seats.filter(
      (seat) => !existingSeats.includes(seat)
    );

    // Populate the select dropdown with seat options
    availableSeats.forEach((seat) => {
      const option = document.createElement("option");
      option.value = seat;
      option.textContent = seat;
      seatSelect.appendChild(option);
    });

    // Event listener to update the seat price based on the selected seat
    seatSelect.addEventListener("change", function () {
      const selectedSeat = seatSelect.value;
      let price = 70000; // Default price

      if (selectedSeat.match(/^[CDEF][3-6]$/)) {
        price = 80000;
      } else if (selectedSeat.match(/^H[1-8]$/)) {
        price = 90000;
      }

      seatPrice.value = price.toLocaleString("en-US");
    });
  });
</script>
<!-- Install Extension CORS để sử dụng hàm -->
<!-- https://chromewebstore.google.com/detail/cors-unblock/lfhmikememgdcahcdlaciloancbhjino?hl=vi -->
<script>
  $(document).ready(function () {
    $("#cinemaSelect").change(function () {
      const selectedCinemaId = $(this).val();
      const token = "<%= token %>";

      $.ajax({
        url: `http://139.180.132.97:3000/rooms/room/cinema?cinemaId=${selectedCinemaId}`,
        data: { cinemaId: selectedCinemaId },
        headers: {
          Authorization: `Bearer ${token}`,
        },
        success: function (data) {
          $("#roomSelect").empty();
          $("#roomSelect").append(
            $("<option>")
              .text("Chọn Phòng Chiếu...")
              .attr("disabled", "disabled")
              .attr("selected", "selected")
          );

          let showtimes = [];
          for (let i = 0; i < data.length; i++) {
            const option = $("<option>").val(data[i]._id).text(data[i].name);
            $("#roomSelect").append(option);

            if (data[i].showtime && Array.isArray(data[i].showtime)) {
              showtimes = showtimes.concat(data[i].showtime);
            }
          }

          const uniqueDates = Array.from(
            new Set(showtimes.map((st) => st.date))
          );

          $("#showDataSelect").empty();
          $("#showDataSelect").append(
            $("<option>")
              .text("Chọn Ngày Chiếu...")
              .attr("disabled", "disabled")
              .attr("selected", "selected")
          );

          uniqueDates.forEach((date) => {
            const dateOption = $("<option>")
              .val(date)
              .text(new Date(date).toLocaleDateString());
            $("#showDataSelect").append(dateOption);
          });

          $("#showDataSelect").change(function () {
            const selectedDate = $(this).val();
            const selectedShowtime = showtimes.find(
              (st) => st.date === selectedDate
            );

            $("#timeSelect").empty();
            $("#timeSelect").append(
              $("<option>")
                .text("Chọn Giờ Chiếu...")
                .attr("disabled", "disabled")
                .attr("selected", "selected")
            );

            if (selectedShowtime && Array.isArray(selectedShowtime.time)) {
              selectedShowtime.time.forEach((timeObj) => {
                const timeOption = $("<option>")
                  .val(timeObj._id)
                  .text(timeObj.time);
                $("#timeSelect").append(timeOption);
              });
            }
          });
        },
        error: function (error) {
          console.error("Error fetching rooms:", error);
        },
      });
    });
  });
</script>
<!-- Xem ghế -->
<script>
  $(document).ready(function () {
    $("#viewSeatsBtn").click(function () {
      const token = "<%= token %>";
      const roomId = $("#roomSelect").val();
      if (roomId) {
        $.ajax({
          url: `http://139.180.132.97:3000/seats/room/${roomId}`,
          method: "GET",
          headers: {
            Authorization: `Bearer ${token}`,
          },
          success: function (data) {
            $("#seats").empty(); // Xóa các ghế hiện tại nếu có

            // Sắp xếp các tên ghế theo thứ tự alphabet
            const sortedSeats = data.sort((a, b) => {
              const rowA = a.name.charAt(0);
              const rowB = b.name.charAt(0);
              const numA = parseInt(a.name.slice(1));
              const numB = parseInt(b.name.slice(1));

              if (rowA < rowB) return -1;
              if (rowA > rowB) return 1;
              return numA - numB;
            });

            // Hiển thị các ghế sau khi sắp xếp
            sortedSeats.forEach(function (seat) {
              const seatButton = `<div class="col-md-1 mb-3">
                                    <button class="btn btn-secondary w-100">${seat.name}</button>
                                  </div>`;
              $("#seats").append(seatButton);
              existingSeats.push(seat.name);
            });
          },
          error: function (error) {
            console.error("Error fetching seats:", error);
          },
        });
      } else {
        console.log("Please select a room.");
      }
    });
  });
</script>
